# MOEX Bot

Инструментарий для автоматической торговли через Tinkoff Invest API. Проект включает
единый движок `Engine`, обновляемые данные, расширенный риск-менеджер и набор
интерфейсов управления.

## Установка и запуск

```bash
python -m venv .venv
# Windows: .venv\Scripts\activate
# Linux/macOS: source .venv/bin/activate
pip install -e .
```

После установки доступны консольные команды:

- `moex-live` — запуск живого цикла через `Engine`.
- `moex-backtests` — пакетный прогон стратегий и формирование отчётов.
- `moex-server` — FastAPI + Dash сервер с веб-панелью.
- `moex-all` — последовательный запуск бэктеста, сервера и планировщика.
- `moex-diagnostics` — проверка окружения и подключения к Tinkoff API.
- `moex-desktop` — настольная оболочка на Tkinter.
- `moex-package` — сборка Docker-образа или автономного `.exe`.

Для Windows предусмотрен скрипт `setup_env.bat`, создающий виртуальное окружение и
устанавливающий проект за один шаг.

## Графический интерфейс

### Веб-панель `/dashboard`

Запустите `moex-server` и откройте `http://127.0.0.1:8000/dashboard`.

- **Обзор** — свечной график с SMA, индикаторы волатильности и доходности, таблица позиций,
  карта риск-метрик и диаграмма распределения позиций.
- **Стратегии** — чекбоксы для мгновенного включения/отключения стратегий, запуск бэктеста
  одной кнопкой, индикатор активных алгоритмов.
- **Риски** — поток журнала RiskManager, история сессий с режимами и просадками.
- **Планировщик** — визуализация cron-задач из `config.yaml`.

Панель обновляется каждые 15 секунд и напрямую использует методы `Engine`:
`list_strategies()`, `set_strategy_enabled()`, `positions_snapshot()` и др.

### Настольное приложение `moex-desktop`

Tkinter-интерфейс подключается к тому же движку и предоставляет:

- кнопки «Старт», «Стоп», «Переключить режим»;
- чекбоксы стратегий, синхронизированные с движком;
- карточки капитала, PnL, gross exposure и просадки;
- таблицу позиций и оперативный журнал RiskManager;
- запуск бэктеста без выхода в терминал.

Приложение безопасно закрывает сессию и поддерживает обновление данных каждые 2 секунды.

## Сборка и дистрибуция

Для конечных пользователей доступны готовые сборки:

- `moex-package exe --entry moex_bot.run_server:main` — создаёт автономный `.exe`
  (требуется `pip install pyinstaller`).
- `moex-package docker --tag yourname/moex-bot:latest` — собирает образ на основе
  `moex_bot/Dockerfile`.

Dockerfile включает FastAPI/Dash, APScheduler и зависимости отчётности. При необходимости
добавьте свои `RUN` инструкции (например, для установки `tinkoff-invest`).

## Автоматическое обновление данных

`moex_bot/update_data.py` загружает исторические свечи и расширяет вселенную инструментов
(акции 1–3 уровней, ETF, облигации, фьючерсы и валюты). Функцию `run_scheduled_update`
можно подключить к планировщику в `config.yaml`:

```yaml
schedule:
  data_update:
    func: "moex_bot.update_data.run_scheduled_update"
    cron: "30 6 * * 1-5"
```

Для запуска всех задач используется `run_scheduler.py` либо команда `moex-all`. Планировщик основан на
APScheduler и читает задания из раздела `schedule` конфигурации.

## Риск-менеджер

`RiskManager` поддерживает:

- лимиты по инструментам (`max_position_pct`, `max_lots`, `max_leverage`);
- ограничения по классам активов и автоматическое принудительное закрытие;
- поток мониторинга просадки с регулируемым интервалом;
- журналы событий и equity (`results/risk_journal.csv`, `results/session_history.csv`);
- уведомления в Telegram и интеграцию с Desktop/Web интерфейсами.

Метод `session_summary()` используется панелями и CLI для консистентного отображения метрик.

## Конфигурация

`config.yaml` можно расширять фрагментами в `config.d/*.yaml`. Загрузчик объединяет их с
разворачиванием переменных окружения (`${VAR}`). Основные блоки:

- `data` — интервал и глубина истории, дополнительные тикеры, экспорт списка FIGI;
- `strategies` — параметры стратегий, список тикеров для live-режима;
- `risk` — настройки RiskManager, лимиты по инструментам и классам активов;
- `portfolio` — целевые доли стратегий для `PortfolioManager`;
- `auto_selector` — фильтры авто-подбора стратегий в отчётах;
- `schedule` — cron-задачи (бэктесты, обновление данных, live-цикл).

## Переменные окружения

Секреты задаются через `.env` или переменные окружения:

- `TINKOFF_TOKEN`, `TINKOFF_ACCOUNT_ID`, `TINKOFF_SANDBOX` и sandbox-параметры;
- `TELEGRAM_TOKEN`, `TELEGRAM_CHAT_ID`, `MOEX_ADMIN_TOKEN` для API и уведомлений;
- `PROM_PORT` — порт Prometheus.

Файл `.env.example` содержит образец заполнения.

## Дополнительные материалы

- `universe_ru.py` — генераторы вселенных (акции 1–3 эшелонов, ETF, облигации, фьючерсы, FX).
- `run_diagnostics.py` — проверка версий Python, зависимости и доступности Tinkoff API.
- `reporting/` — шаблоны и утилиты формирования отчётов (CSV/HTML/JSON/Parquet).

Проект развивается: docstring’и и логирование ведутся на русском языке, а линтеры `black`
и `flake8` поддерживаются во время разработки.
